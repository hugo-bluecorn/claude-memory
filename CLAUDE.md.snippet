# Session Management

This project uses an automated session continuity system with hooks and commands.

## How It Works

1. **Automatic backup** - Hooks save raw transcripts when sessions end or compact
2. **Opt-in restore** - Run `/resume-latest` to process backups and restore context
3. **Manual save** - Run `/document-and-save` to create a high-quality session summary

## Key Files

| File | Purpose | Auto-Loaded |
|------|---------|-------------|
| `.claude/memory/active-context.md` | Current session state | Yes |
| `.claude/memory/project-memory.md` | Permanent project knowledge | Yes |
| `.claude/memory/sessions/session-*.md` | Archived session documents | No |
| `.claude/memory/raw/*.jsonl` | Raw transcript backups | No |

## Hooks (Automatic)

| Hook | Trigger | Action |
|------|---------|--------|
| `on-session-end.sh` | `/exit`, `/clear`, logout | Saves transcript, creates `.pending-backup-exit` |
| `on-pre-compact.sh` | Context ~90% full | Saves transcript, creates `.pending-backup-compact` |
| `on-session-start.sh` | Session starts | Outputs `SESSION_BACKUP_PENDING` if backup exists |

## Commands (Manual)

| Command | Purpose |
|---------|---------|
| `/document-and-save` | Save session summary to default path |
| `/document-and-save-to <path>` | Save session summary to specific path |
| `/resume-latest` | Process pending backup or load most recent session |
| `/resume-from <path>` | Load specific session document |
| `/coalesce` | Merge delta work from compaction into last session doc |
| `/sessions-list` | Browse available session logs |
| `/search-sessions <keyword>` | Search across session documents |
| `/cleanup-backups` | Delete old backup files |
| `/discard-backup` | Discard pending backup without processing |
| `/context-stats` | View session management statistics |

## Rules for Session Management

1. **On `/document-and-save`**:
   - **FIRST** update `active-context.md` with condensed summary
   - **THEN** write the full session document
   - This order prevents data loss from auto-compaction race conditions

2. **On processing pending backup** (via `/resume-latest`):
   - Read the raw JSONL backup file
   - Parse conversation history and generate summary
   - Update `active-context.md`
   - Delete the `.pending-backup-*` marker

3. **Context recovery is opt-in**:
   - SessionStart hook outputs to stdout (visible to Claude, not user)
   - User must run `/resume-latest` or `/sessions-list` to restore context

4. **Proactive documentation**:
   - Document at natural milestones (phase completion, major feature done)
   - Don't wait for context limits

5. **Project memory updates**:
   - Add important patterns, gotchas, or decisions to `project-memory.md`

---

## Session Context

@.claude/memory/active-context.md

## Project Knowledge

@.claude/memory/project-memory.md
